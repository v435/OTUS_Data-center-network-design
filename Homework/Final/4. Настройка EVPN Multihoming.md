Второй и третий уровень в нашей EVPN-сети мы настроили, но что если на наших клиентах крутятся Очень Важные Сервисы, и нам необходимо зарезервировать подключение для таких серверов не только на уровне линка, но и на уровне коммутатора?

Нам на помощь придет родная встроенная функциональность для подключения клиента к VTEP множественными линками - EVPN Multihoming. Также его еще называют "ESI Multihoming" или "ESI LAG". Все эти термины обозначают одно и то же. EVPN Multihoming может работать как в режиме All-Active (все линки могут быть активны и передавать unicast-трафик одновременно) или в режиме Single-Active, когда активен может быть только один линк.

В отличие от проприетатных решений на основе MLAG, EVPN Multihoming не требует отдельного peer-link и не накладывает жесткого ограничения на максимальное количество PE-устройств, обслуживающих multihomed-систему (хотя количество поддерживаемых устройств для организации резервируемого подключения зависит от ограничений конкретного вендора). Также в теории должна наличествовать межвендорная совместимость, но это в теории, а практика, увы, зачастую доказывает обратное.

Multihomed-системой со стороны клиента может выступать как L3-узел (сервер, маршрутизатор), так и L2-узел (коммутатор). В том случае, когда клиентской системой является коммутатор, **и** при этом используется модель работы All-Active, то линки, ведущие к VTEP'ам, обязательно должны быть аггрегированы в LAG. Либо же, если LAG использовать не представляется возможным, в конкретном VLAN должен быть одновременно активен только один линк.

Для работы Multihoming в EVPN задействуются два новых типа маршрутов: RT-1 (Ethernet Auto-discovery Route) и RT-4 (Ethernet Segment Route). RT-1 помогает VTEP'ам динамически обнаруживать соседей, подключенных в один и тот же сегмент (+ эта информация используется для организации функциональности ECMP, предотвращения возникновения L2-петель и т.д.). RT-4 нужен для организации выбора Designated Forwarder'а для сегмента - то есть VTEP'а, который в режиме работы Multihoming All-Active будет иметь право передавать BUM-трафик в сегмент.

Сегмент в данном случае - это набор линков, ведущих к одной и той же клиентской системе. Или, иначе, набор линков, которыми конкретная клиентская система подключается к EVPN-сети. Каждый сегмент в EVPN имеет идентификатор ESI (Ethernet Segment Identifier). Single-homed-сегмент всегда имеет ESI 0. Multihomed-сегмент имеет ESI > 0.

В стандартном сценарии на multihomed-клиенте настраивается обычный агрегированный канал - LAG, например на основе широко применяемого протокола 802.3ad (LACP).

# Клиенты, адреса и топология
Здесь нам снова придется немножко изменить нашу топологию. От каждого клиента дополнительно пробросим еще один линк в сторону резервирующего Leaf'а. Первого и второго клиента мы посадим в один L2-домен, третьего и четвертого клиента посадим в другой L2-домен.

![[mh.drawio.png]]

IRB-интерфейсы на Leaf'ах:

| Устройство | IRB               | VLAN |
| ---------- | ----------------- | ---- |
| Leaf-1     | 192.168.10.254/24 | 10   |
| Leaf-2     | 192.168.10.254/24 | 10   |
| Leaf-2     | 192.168.20.254/24 | 20   |
| Leaf-3     | 192.168.20.254/24 | 20   |

MAC, IP-адреса, VLAN, VNI клиентов, подключенных к Leaf-устройствам:

| Клиент   | MAC (LAG Interface) | IP/Mask         | VLAN |
| -------- | ------------------- | --------------- | ---- |
| Client-1 | 02:00:00:00:01:bb   | 192.168.10.1/24 | 10   |
| Client-2 | 02:00:00:00:02:bb   | 192.168.10.2/24 | 10   |
| Client-3 | 02:00:00:00:03:bb   | 192.168.20.3/24 | 20   |
| Client-4 | 02:00:00:00:04:bb   | 192.168.20.4/24 | 20   |

VXLAN:

| VLAN | VNI  | RT       |
| ---- | ---- | -------- |
| 10   | 1010 | 1:1010 |
| 20   | 1020 | 1:1020 |

L3VNI для VRF1 будет назначен на VNI 1000, RT будет 1:1000.

Идентификаторы ESI, LACP MAC'и и route target'ы для RT-4:

| Client   | ESI                      | ES-Import-RT      | LACP System-ID |
| -------- | ------------------------ | ----------------- | -------------- |
| Client-1 | 0000:0000:0000:0000:0001 | 00:00:00:00:00:01 | 02aa.aaaa.0001 |
| Client-2 | 0000:0000:0000:0000:0002 | 00:00:00:00:00:02 | 02aa.aaaa.0002 |
| Client-3 | 0000:0000:0000:0000:0003 | 00:00:00:00:00:03 | 02aa.aaaa.0003 |
| Client-4 | 0000:0000:0000:0000:0004 | 00:00:00:00:00:04 | 02aa.aaaa.0004 |

# Настройка
Опять же, настройка Spine у нас никак не меняется, поэтому снова описывать ее не будем. Давайте сразу перейдем к настройке лифов. Сбросим на них настройки overlay, то есть вернемся к тому состоянию, когда у нас был настроен underlay - я приведу начальную конфигурацию для каждого лифа, и оттуда уже начнем настраивать.

## Настройка Leaf-1
Начальная конфигурация, с которой мы начинаем настройку (настроен underlay):
```
service routing protocols model multi-agent
!
hostname Leaf-1
!
interface Ethernet1
   description Link_to_Spine-1
   no switchport
   ipv6 enable
!
interface Ethernet2
   description Link_to_Spine-2
   no switchport
   ipv6 enable
!
interface Ethernet3
   shutdown
!
interface Ethernet4
   shutdown
!
interface Ethernet5
   shutdown
!
interface Ethernet6
   shutdown
!
interface Ethernet7
   shutdown
!
interface Loopback0
   ip address 10.1.1.1/32
!
ip routing ipv6 interfaces
!
ipv6 unicast-routing
!
route-map BGP_REDISTRIBUTE_CONNECTED permit 10
   match interface Loopback0
!
router bgp 65001
   maximum-paths 64
   neighbor CLOS peer group
   neighbor CLOS out-delay 0
   neighbor CLOS bfd
   neighbor CLOS timers 3 9
   neighbor CLOS password OTUS
   redistribute connected route-map BGP_REDISTRIBUTE_CONNECTED
   neighbor interface Et1-2 peer-group CLOS remote-as 65100
   !
   address-family ipv4
      neighbor CLOS activate
      neighbor CLOS next-hop address-family ipv6 originate
!
end
```

А теперь к настройке EVPN.

Создадим VLAN 10, в котором будут у нас сидеть Client-1 и Client-2:
```
Leaf-1(config)# vlan 10
Leaf-1(config-vlan-10)# name Clients_10
```

Создадим клиентский VRF и сразу включим для него маршрутизацию:
```
Leaf-1(config)# vrf instance VRF1

Leaf-1(config)# ip routing vrf VRF1
```

Создадим LAG-интерфейсы, которые будут смотреть в сторону клиентов. В сторону каждого из клиентов на этом лифе будет смотреть одна нога (вторая будет на соседнем Leaf'е - ведь у нас ESI LAG):
```
Leaf-1(config)# interface Port-Channel1
Leaf-1(config-if-Po1)# description Link_to_Client-1
Leaf-1(config-if-Po1)# switchport access vlan 10
Leaf-1(config-if-Po1)# evpn ethernet-segment
Leaf-1(config-evpn-es)# identifier 0000:0000:0000:0000:0001
Leaf-1(config-evpn-es)# route-target import 00:00:00:00:00:01
Leaf-1(config-evpn-es)# lacp system-id 02aa.aaaa.0001

Leaf-1(config)# interface Port-Channel2
Leaf-1(config-if-Po2)# description Link_to_Client-2
Leaf-1(config-if-Po2)# switchport access vlan 10
Leaf-1(config-if-Po2)# evpn ethernet-segment
Leaf-1(config-evpn-es)# identifier 0000:0000:0000:0000:0002
Leaf-1(config-evpn-es)# route-target import 00:00:00:00:00:02
Leaf-1(config-evpn-es)# lacp system-id 02aa.aaaa.0002
```

Здесь мы выполняем важные для функционирования multihoming настройки, поэтому давайте поподробнее остановимся на том, что мы вообще здесь делаем.

Помимо перевода интерфейса в режим VLAN 10 Untagged, мы здесь задаем MAC-адрес LACP-канала с помощью команды `lacp system-id`. Он должен быть одинаковым на обоих Leaf'ах-членах Port-Channel'а. Это нужно для того, чтобы клиент считал, что оба его LAG-линка ведут к одному устройству (он ведь ничего не знает ни про какие мультихоминги, для него канал выглядит как совершенно обычный агрегированный канал).

Также в этой секции мы задаем две настройки, связанные с multihomed-Ethernet-сегментом: идентификатор сегмента (ESI) и Route target сегмента. Идентификатор сегмента будет уникально обозначать данный линк как часть глобально (в рамках фабрики) уникального набора линков, ведущих к одной и той же клиентской multihomed-системе, или даже, точнее, к одному клиентскому подключению (сайту). Благодаря ненулевому идентификатору сегмента наши VTEP'ы будут четко понимать, кто еще из EVPN-пиров смотрит в этот же сегмент, или, другими словами, подключен к этой же клиентской системе.

На основе идентификатора сегмента будет сгенерирован маршрут RT-1 (Ethernet Auto-discovery route), который будет использоваться VTEP'ами для обнаружения соседей, смотрящих в этот же сегмент, для предотвращения закольцовывания BUM-трафика и для ECMP. ECMP означает следующее: неважно, с какого VTEP'а был получен RT-2 маршрут: другие VTEP'ы в фабрике будут знать, что трафик до конкретной системы в конкретном Ethernet-сегменте можно отправить на _любой_ VTEP, имеющий подключение к этому же самому Ethernet-сегменту. Такое поведение называется Aliasing. В случае использования схемы Single-Active, линки других VTEP'ов будут использоваться как резервные.

Также в этой секции мы задаем ES-Import Route Target. Назначение этого комьюнити требуется для генерации и приема маршрутов RT-4 (Ethernet Segment route). Благодаря этому комьюнити VTEP'ы, подключенные к одному сегменту, будут импортировать маршруты RT-4, относящиеся к этому ESI.

Вообще, маршрут RT-4 нужен для того, чтобы VTEP'ы, подключенные к одному сегменту, смогли выбрать Designated Forwarder'а, то есть VTEP, которому будет разрешено пересылать BUM-трафик **в ES-сегмент** (нужно для предотвращения дублирования BUM-трафика в сторону клиентской системы, ведь все VTEP'ы, подключенные к сегменту, получат из overlay-сети, от удаленного VTEP, по отдельной копии BUM-пакета, и в обычной ситуации каждый бы отправил свою копию в сторону клиента).

Здесь особенно важно помнить, что VTEP'ы, не являющиеся DF, не имеют права отправлять трафик **в сегмент**, но на BUM-трафик, полученный **из сегмента**, от multihomed-клиента, подобных ограничений не налагается, и такой трафик может быть передан без какой-бы то ни было оглядки на статус DF/Non-DF. Более того, существует еще правило, называемое "локальным предпочтением" (local bias). Оно гласит, что VTEP имеет право пересылать BUM-трафик, полученный с собственных физических access-портов, в локально подключенный multihomed-сегмент **вне зависимости от своего статуса DF/Non-DF**. Что, в-общем-то, логично. Зачем гонять трафик по фабрике, когда мы физически подключены к сегменту назначения, а трафик, который нужно переслать в сегмент, был порожден нашими же локальными клиентами?

На этом настройки, связанные непосредственно с Multihoming, закончены :). Идем дальше.

Назначим физические линки к клиентам в Port-Channel'ы (сделаем их членами LAG):

```
Leaf-1(config)# interface Ethernet3
Leaf-1(config-if-Et3)# description Link_to_Client-1
Leaf-1(config-if-Et3)# channel-group 1 mode active
Leaf-1(config-if-Et3)# no shutdown

Leaf-1(config-if-Et3)# interface Ethernet4
Leaf-1(config-if-Et4)# description Link_to_Client-2
Leaf-1(config-if-Et4)# channel-group 2 mode active
Leaf-1(config-if-Et4)# no shutdown
```

"mode active" означает, что мы будем активно пытаться установить LACP-соседство вместо того, чтобы пассивно ожидать, пока нас позовут его оформить с другой стороны :).

Настроим IRB-интерфейсы, нужно для обеспечения маршрутизации из нашего VNI. Задаем IP-адрес шлюза по умолчанию (он же Static Anycast Gateway). Этот интерфейс назначаем в наш VRF1:
```
Leaf-1(config)# interface Vlan10
Leaf-1(config-if-Vl10)# vrf VRF1
Leaf-1(config-if-Vl10)# ip address virtual 192.168.10.254/24
```

Настраиваем плоскость данных VXLAN. Указываем, откуда брать Source IP для VXLAN-пакетов (с Loopback'а), задаем соответствие vlan 10 и vni 1010. Создаем L3VNI путем назначения VRF1 на "виэнайку" 1000.
```
Leaf-1(config)# interface Vxlan1
Leaf-1(config-if-Vx1)# vxlan source-interface Loopback0
Leaf-1(config-if-Vx1)# vxlan vlan 10 vni 1010
Leaf-1(config-if-Vx1)# vxlan vrf VRF1 vni 1000
```

Зададим anycast-MAC для наших IRB-интерфейсов. В нашей схеме Anycast IP/Anycast MAC он должен быть одинаковым на всех IRB-интерфейсах конкретного VNI:
```
Leaf-1(config)# ip virtual-router mac-address 02:aa:aa:aa:aa:aa
```

Включим отсылку расширенных комьюнити для EVPN (Route Target'ы, всякие Router's MAC'и и т.д.):
```
Leaf-1(config)# router bgp 65001
Leaf-1(config-router-bgp)# neighbor CLOS send-community extended
```

Пропишем для нашего MAC-VRF, относящегося к VLAN 10, соответствующий RD и RT (RD, точнее, не пропишем, а попросим Аристу генерировать его автоматически). Включим распространение информации о локально подключенных хостах в EVPN с помощью команды redistribute learned.
```
Leaf-1(config)# router bgp 65001
Leaf-1(config-router-bgp)# vlan 10
Leaf-1(config-macvrf-10)# rd auto
Leaf-1(config-macvrf-10)# route-target both 1:1010
Leaf-1(config-macvrf-10)# redistribute learned
```

Активируем AFI/SAFI EVPN для нашего процесса MP-BGP:
```
Leaf-1(config)# router bgp 65001
Leaf-1(config-router-bgp)# address-family evpn
Leaf-1(config-router-bgp-af)# neighbor CLOS activate
```

Ну и последнее - зададим RD и RT для нашей L3VNI:
```
Leaf-1(config)# router bgp 65001
Leaf-1(config-router-bgp)# vrf VRF1
Leaf-1(config-router-bgp-vrf-VRF1)# rd 10.1.1.1:1000
Leaf-1(config-router-bgp-vrf-VRF1)# route-target import evpn 1:1000
Leaf-1(config-router-bgp-vrf-VRF1)# route-target export evpn 1:1000
```

Общий вид настроек, которые мы только что задали:
```
vlan 10
   name Clients_10
!
vrf instance VRF1
!
interface Port-Channel1
   description Link_to_Client-1
   switchport access vlan 10
   !
   evpn ethernet-segment
      identifier 0000:0000:0000:0000:0001
      route-target import 00:00:00:00:00:01
   lacp system-id 02aa.aaaa.0001
!
interface Port-Channel2
   description Link_to_Client-2
   switchport access vlan 10
   !
   evpn ethernet-segment
      identifier 0000:0000:0000:0000:0002
      route-target import 00:00:00:00:00:02
   lacp system-id 02aa.aaaa.0002
!
interface Ethernet3
   description Link_to_Client-1
   channel-group 1 mode active
   no shutdown
!
interface Ethernet4
   description Link_to_Client-2
   channel-group 2 mode active
   no shutdown
!
interface Vlan10
   vrf VRF1
   ip address virtual 192.168.10.254/24
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan vlan 10 vni 1010
   vxlan vrf VRF1 vni 1000
!
ip virtual-router mac-address 02:aa:aa:aa:aa:aa
!
ip routing vrf VRF1
!
router bgp 65001
   neighbor CLOS send-community extended
   !
   vlan 10
      rd auto
      route-target both 1:1010
      redistribute learned
   !
   address-family evpn
      neighbor CLOS activate
   !
   vrf VRF1
      rd 10.1.1.1:1000
      route-target import evpn 1:1000
      route-target export evpn 1:1000
```

Всё. Остальные коммутаторы Leaf настраиваем по той же схеме. Буду приводить только общий вид настроек, без объяснения каждой конкретной опции, чтобы не повторяться об одном и том же.

## Настройка Leaf-2
Начальная конфигурация:
```
service routing protocols model multi-agent
!
hostname Leaf-2
!
interface Ethernet1
   description Link_to_Spine-1
   no switchport
   ipv6 enable
!
interface Ethernet2
   description Link_to_Spine-2
   no switchport
   ipv6 enable
!
interface Ethernet3
   shutdown
!
interface Ethernet4
   shutdown
!
interface Ethernet5
   shutdown
!
interface Ethernet6
   shutdown
!
interface Ethernet7
   shutdown
!
interface Loopback0
   ip address 10.1.1.2/32
!
ip routing ipv6 interfaces
!
ipv6 unicast-routing
!
route-map BGP_REDISTRIBUTE_CONNECTED permit 10
   match interface Loopback0
!
router bgp 65002
   maximum-paths 64
   neighbor CLOS peer group
   neighbor CLOS out-delay 0
   neighbor CLOS bfd
   neighbor CLOS timers 3 9
   neighbor CLOS password OTUS
   redistribute connected route-map BGP_REDISTRIBUTE_CONNECTED
   neighbor interface Et1-2 peer-group CLOS remote-as 65100
   !
   address-family ipv4
      neighbor CLOS activate
      neighbor CLOS next-hop address-family ipv6 originate
!
end
```

Конфигурация с настроенным overlay и multihoming'ом, согласно нашим задачам.
```
vlan 10
   name Clients_10
!
vlan 20
   name Clients_20
!
vrf instance VRF1
!
interface Port-Channel1
   description Link_to_Client-1
   switchport access vlan 10
   !
   evpn ethernet-segment
      identifier 0000:0000:0000:0000:0001
      route-target import 00:00:00:00:00:01
   lacp system-id 02aa.aaaa.0001
!
interface Port-Channel2
   description Link_to_Client-2
   switchport access vlan 10
   !
   evpn ethernet-segment
      identifier 0000:0000:0000:0000:0002
      route-target import 00:00:00:00:00:02
   lacp system-id 02aa.aaaa.0002
!
interface Port-Channel3
   description Link_to_Client-3
   switchport access vlan 20
   !
   evpn ethernet-segment
      identifier 0000:0000:0000:0000:0003
      route-target import 00:00:00:00:00:03
   lacp system-id 02aa.aaaa.0003
!
interface Port-Channel4
   description Link_to_Client-4
   switchport access vlan 20
   !
   evpn ethernet-segment
      identifier 0000:0000:0000:0000:0004
      route-target import 00:00:00:00:00:04
   lacp system-id 02aa.aaaa.0004
!
interface Ethernet3
   description Link_to_Client-1
   channel-group 1 mode active
   no shutdown
!
interface Ethernet4
   description Link_to_Client-2
   channel-group 2 mode active
   no shutdown
!
interface Ethernet5
   description Link_to_Client-3
   channel-group 3 mode active
   no shutdown
!
interface Ethernet6
   description Link_to_Client-4
   channel-group 4 mode active
   no shutdown
!
interface Vlan10
   vrf VRF1
   ip address virtual 192.168.10.254/24
!
interface Vlan20
   vrf VRF1
   ip address virtual 192.168.20.254/24
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan vlan 10 vni 1010
   vxlan vlan 20 vni 1020
   vxlan vrf VRF1 vni 1000
!
ip virtual-router mac-address 02:aa:aa:aa:aa:aa
!
ip routing vrf VRF1
!
router bgp 65002
   neighbor CLOS send-community extended
   !
   vlan 10
      rd auto
      route-target both 1:1010
      redistribute learned
   !
   vlan 20
      rd auto
      route-target both 1:1020
      redistribute learned
   !
   address-family evpn
      neighbor CLOS activate
   !
   vrf VRF1
      rd 10.1.1.1:1000
      route-target import evpn 1:1000
      route-target export evpn 1:1000
```
Лишь вкратце скажу, что мы на Leaf-2 на клиентских портах Po1 и Po2 настраиваем вторую ногу LAG для клиентов, которые также подключены к Leaf-1, а на портах Po3 и Po4 - одну из ног для клиентов Client-3 и Client-4.

## Настройка Leaf-3
Начальная конфигурация:
```
service routing protocols model multi-agent
!
hostname Leaf-3
!
interface Ethernet1
   description Link_to_Spine-1
   no switchport
   ipv6 enable
!
interface Ethernet2
   description Link_to_Spine-2
   no switchport
   ipv6 enable
!
interface Ethernet3
   shutdown
!
interface Ethernet4
   shutdown
!
interface Ethernet5
   shutdown
!
interface Ethernet6
   shutdown
!
interface Ethernet7
   shutdown
!
interface Loopback0
   ip address 10.1.1.3/32
!
ip routing ipv6 interfaces
!
ipv6 unicast-routing
!
route-map BGP_REDISTRIBUTE_CONNECTED permit 10
   match interface Loopback0
!
router bgp 65003
   maximum-paths 64
   neighbor CLOS peer group
   neighbor CLOS out-delay 0
   neighbor CLOS bfd
   neighbor CLOS timers 3 9
   neighbor CLOS password OTUS
   redistribute connected route-map BGP_REDISTRIBUTE_CONNECTED
   neighbor interface Et1-2 peer-group CLOS remote-as 65100
   !
   address-family ipv4
      neighbor CLOS activate
      neighbor CLOS next-hop address-family ipv6 originate
!
end
```

Конфигурация overlay с подключением клиентов с услугой multihoming:
```
vlan 20
   name Clients_20
!
vrf instance VRF1
!
interface Port-Channel3
   description Link_to_Client-3
   switchport access vlan 20
   !
   evpn ethernet-segment
      identifier 0000:0000:0000:0000:0003
      route-target import 00:00:00:00:00:03
   lacp system-id 02aa.aaaa.0003
!
interface Port-Channel4
   description Link_to_Client-4
   switchport access vlan 20
   !
   evpn ethernet-segment
      identifier 0000:0000:0000:0000:0004
      route-target import 00:00:00:00:00:04
   lacp system-id 02aa.aaaa.0004
!
interface Ethernet5
   description Link_to_Client-3
   channel-group 3 mode active
   no shutdown
!
interface Ethernet6
   description Link_to_Client-4
   channel-group 4 mode active
   no shutdown
!
interface Vlan20
   vrf VRF1
   ip address virtual 192.168.20.254/24
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan vlan 20 vni 1020
   vxlan vrf VRF1 vni 1000
!
ip virtual-router mac-address 02:aa:aa:aa:aa:aa
!
ip routing vrf VRF1
!
router bgp 65003
   neighbor CLOS send-community extended
   !
   vlan 20
      rd auto
      route-target both 1:1020
      redistribute learned
   !
   address-family evpn
      neighbor CLOS activate
   !
   vrf VRF1
      rd 10.1.1.1:1000
      route-target import evpn 1:1000
      route-target export evpn 1:1000
```
На этом лифе мы настраиваем вторую ногу LAG для клиентов Client-3 и Client-4.

Приведу еще настройки клиентов. Тут ничего необычного - виртуалки на основе Alpine Linux, настройки выполнены в файле /etc/network/interfaces, создан LACP LAG на двух интерфейсах, смотрящих в разные VTEP'ы.

## Настройка Client-1
```
Client-1:~# cat /etc/network/interfaces 
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet manual

auto eth1
iface eth1 inet manual

auto bond0
iface bond0 inet static
        address 192.168.10.1
        netmask 255.255.255.0
        gateway 192.168.10.254
        bond-slaves eth0 eth1
        bond-mode 802.3ad
        hwaddress 02:01:00:00:00:01
```

## Настройка Client-2
```
Client-2:~# cat /etc/network/interfaces 
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet manual

auto eth1
iface eth1 inet manual

auto bond0
iface bond0 inet static
        address 192.168.10.2
        netmask 255.255.255.0
        gateway 192.168.10.254
        bond-slaves eth0 eth1
        bond-mode 802.3ad
        hwaddress 02:01:00:00:00:02
```

## Настройка Client-3
```
Client-3:~# cat /etc/network/interfaces 
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet manual

auto eth1
iface eth1 inet manual

auto bond0
iface bond0 inet static
        address 192.168.20.3
        netmask 255.255.255.0
        gateway 192.168.20.254
        bond-slaves eth0 eth1
        bond-mode 802.3ad
        hwaddress 02:01:00:00:00:03
```

## Настройка Client-4
```
Client-4:~# cat /etc/network/interfaces 
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet manual

auto eth1
iface eth1 inet manual

auto bond0
iface bond0 inet static
        address 192.168.20.4
        netmask 255.255.255.0
        gateway 192.168.20.254
        bond-slaves eth0 eth1
        bond-mode 802.3ad
        hwaddress 02:01:00:00:00:04
```

# Проверки

Предлагаю не проверять сейчас каждую мелочь (L2/L3 были проверены в предыдущих ДЗ). Сейчас верифицируем только основной статус BGP (соседство), проверим маршруты RT-1, RT-2, RT-4, разберем, все ли в порядке с нашими ESI, а потом проверим пингами доступность всех клиентов друг до друга. И напоследок - погасим по очереди один и другой линк на одном из клиентов и проверим, будет ли отрабатывать переход трафика с упавшего линка на уцелевший.

С учетом того, что Spine с точки зрения мультихоминга нас особенно не интересуют, давайте сразу проверять лифы.

## Проверка Leaf-1

Давайте в первую очередь проверим состояние LAG'ов для наших клиентов:
Client-1:
```
Leaf-1# show lacp 1 peer
State: A = Active, P = Passive; S=ShortTimeout, L=LongTimeout;
       G = Aggregable, I = Individual; s+=InSync, s-=OutOfSync;
       C = Collecting, X = state machine expired,
       D = Distributing, d = default neighbor state
                 |                        Partner                              
 Port    Status  | Sys-id                    Port#   State     OperKey  PortPri
------ ----------|------------------------- ------- --------- --------- -------
Port Channel Port-Channel1:                                            
 Et3     Bundled | FFFF,02-00-00-00-01-01        1   ALGs+CD    0x0009      255
```
Client-2:
```
Leaf-1# show lacp 2 peer
State: A = Active, P = Passive; S=ShortTimeout, L=LongTimeout;
       G = Aggregable, I = Individual; s+=InSync, s-=OutOfSync;
       C = Collecting, X = state machine expired,
       D = Distributing, d = default neighbor state
                 |                        Partner                              
 Port    Status  | Sys-id                    Port#   State     OperKey  PortPri
------ ----------|------------------------- ------- --------- --------- -------
Port Channel Port-Channel2:                                            
 Et4     Bundled | FFFF,02-00-00-00-02-01        1   ALGs+CD    0x0009      255
```
Каналы до клиентов подняты, все, вроде бы, в порядке.

Маршрутов BGP у нас сейчас должно быть достаточно большое количество, поэтому давайте проверим их по отдельности.

### RT-3:
```
Leaf-1# show bgp evpn route-type imet
BGP routing table information for VRF default
Router identifier 10.1.1.1, local AS number 65001
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >      RD: 10.1.1.1:10 imet 10.1.1.1
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:10 imet 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 imet 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.2:20 imet 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 imet 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.3:20 imet 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 imet 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
```
IMET-маршруты мы должны увидеть от каждого VTEP'а для каждого VNI. Тут в принципе все предсказуемо - один IMET мы генерируем сами (VNI 1010), две штуки получаем от Leaf-2 (10.1.1.2) - ведь у него настроены VNI 1010 и VNI 1020. Подробней тут смотреть не вижу смысла. А, ну и ECMP тоже присутствует, как и должно быть - у нас ведь два Spine, через которые мы ходим до других Leaf'ов.

### RT-1 (Ethernet A-D Route):
Вот тут посмотрим поподробнее. VTEP'ы должны сгенерировать по одному маршруту RT-1 для каждого EVI и еще один RT-1 общий для Ethernet-сегмента (без привязки к EVI).

```
Leaf-1# show bgp evpn route-type auto-discovery detail
BGP routing table information for VRF default
Router identifier 10.1.1.1, local AS number 65001
BGP routing table entry for auto-discovery 0 0000:0000:0000:0000:0001, Route Distinguisher: 10.1.1.1:10
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010

BGP routing table entry for auto-discovery 0 0000:0000:0000:0000:0001, Route Distinguisher: 10.1.1.2:10
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010

BGP routing table entry for auto-discovery 0000:0000:0000:0000:0001, Route Distinguisher: 10.1.1.1:1
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0

BGP routing table entry for auto-discovery 0000:0000:0000:0000:0001, Route Distinguisher: 10.1.1.2:1
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0

BGP routing table entry for auto-discovery 0 0000:0000:0000:0000:0002, Route Distinguisher: 10.1.1.1:10
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010

BGP routing table entry for auto-discovery 0 0000:0000:0000:0000:0002, Route Distinguisher: 10.1.1.2:10
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010

BGP routing table entry for auto-discovery 0000:0000:0000:0000:0002, Route Distinguisher: 10.1.1.1:1
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0

BGP routing table entry for auto-discovery 0000:0000:0000:0000:0002, Route Distinguisher: 10.1.1.2:1
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0

BGP routing table entry for auto-discovery 0 0000:0000:0000:0000:0003, Route Distinguisher: 10.1.1.2:20
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020

BGP routing table entry for auto-discovery 0 0000:0000:0000:0000:0003, Route Distinguisher: 10.1.1.3:20
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020

BGP routing table entry for auto-discovery 0000:0000:0000:0000:0003, Route Distinguisher: 10.1.1.2:1
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0

BGP routing table entry for auto-discovery 0000:0000:0000:0000:0003, Route Distinguisher: 10.1.1.3:1
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0

BGP routing table entry for auto-discovery 0 0000:0000:0000:0000:0004, Route Distinguisher: 10.1.1.2:20
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020

BGP routing table entry for auto-discovery 0 0000:0000:0000:0000:0004, Route Distinguisher: 10.1.1.3:20
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020

BGP routing table entry for auto-discovery 0000:0000:0000:0000:0004, Route Distinguisher: 10.1.1.2:1
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0

BGP routing table entry for auto-discovery 0000:0000:0000:0000:0004, Route Distinguisher: 10.1.1.3:1
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnEsiLabel:0
      VNI: 0
```

Каждый маршрут несет в себе идентификатор сегмента - ESI. Видим маршруты, сгенерированные для VNI, а также маршруты с VNI: 0 - это маршруты, сгенерированные для ESI, то есть общие для сегмента. Маршрут per-ESI нужен для обеспечения функциональности fast convergence & mass withdrawal: если у нас падает линк в сегмент, мы отзываем данный маршрут, и все другие VTEP'ы понимают, что любые EVI, доступные в данном сегменте через этот VTEP, становятся недоступными, и трафик слать через этот VTEP в них не стоит. нужно скорректировать next-hop'ы для всех маршрутов, касающихся данного ESI, а если подходящих VTEP'ов не осталось, инвалидировать эти маршруты. 

Взглянем еще раз кратко, чтобы убедиться, что все маршруты на месте (так будет нагляднее):
```
Leaf-1# show bgp evpn route-type auto-discovery 
BGP routing table information for VRF default
Router identifier 10.1.1.1, local AS number 65001
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >      RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0001
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0001
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0001
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0002
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0002
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0002
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 10.1.1.3              -       100     0       65100 65003 i
 * >Ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0003
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0003
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0003
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0003
                                 10.1.1.3              -       100     0       65100 65003 i
 * >Ec    RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 10.1.1.3              -       100     0       65100 65003 i
 * >Ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0004
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0004
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0004
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0004
                                 10.1.1.3              -       100     0       65100 65003 i
```

### RT-4 (Ethernet Segment route):
```
Leaf-1# show bgp evpn route-type ethernet-segment detail
BGP routing table information for VRF default
Router identifier 10.1.1.1, local AS number 65001
BGP routing table entry for ethernet-segment 0000:0000:0000:0000:0001 10.1.1.1, Route Distinguisher: 10.1.1.1:1
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:01
BGP routing table entry for ethernet-segment 0000:0000:0000:0000:0001 10.1.1.2, Route Distinguisher: 10.1.1.2:1
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:01
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:01
BGP routing table entry for ethernet-segment 0000:0000:0000:0000:0002 10.1.1.1, Route Distinguisher: 10.1.1.1:1
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:02
BGP routing table entry for ethernet-segment 0000:0000:0000:0000:0002 10.1.1.2, Route Distinguisher: 10.1.1.2:1
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:02
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:02
BGP routing table entry for ethernet-segment 0000:0000:0000:0000:0003 10.1.1.2, Route Distinguisher: 10.1.1.2:1
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:03
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:03
BGP routing table entry for ethernet-segment 0000:0000:0000:0000:0003 10.1.1.3, Route Distinguisher: 10.1.1.3:1
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:03
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:03
BGP routing table entry for ethernet-segment 0000:0000:0000:0000:0004 10.1.1.2, Route Distinguisher: 10.1.1.2:1
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:04
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:04
BGP routing table entry for ethernet-segment 0000:0000:0000:0000:0004 10.1.1.3, Route Distinguisher: 10.1.1.3:1
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:04
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: TunnelEncap:tunnelTypeVxlan EvpnEsImportRt:00:00:00:00:00:04
```
Здесь мы можем видеть наш RT "ES-Import-RT", который позволяет нашему VTEP'у импортировать маршруты RT-4 только для тех сегментов, которые на нем настроены.

Обычный вывод:
```
Leaf-1# show bgp evpn route-type ethernet-segment 
BGP routing table information for VRF default
Router identifier 10.1.1.1, local AS number 65001
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >      RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.1
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.1
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
 * >Ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
```

### RT-2 (MAC/IP Advertisment route)
Ну и посмотрим подробно на маршруты MAC/IP, чтобы убедиться, что идентификатор ESI в них соответствует тому, что мы настроили:
```
Leaf-1#show bgp evpn route-type mac-ip detail
BGP routing table information for VRF default
Router identifier 10.1.1.1, local AS number 65001
BGP routing table entry for mac-ip 0201.0000.0001, Route Distinguisher: 10.1.1.1:10
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010 ESI: 0000:0000:0000:0000:0001
BGP routing table entry for mac-ip 0201.0000.0001, Route Distinguisher: 10.1.1.2:10
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010 ESI: 0000:0000:0000:0000:0001
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010 ESI: 0000:0000:0000:0000:0001
BGP routing table entry for mac-ip 0201.0000.0001 192.168.10.1, Route Distinguisher: 10.1.1.1:10
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0001
BGP routing table entry for mac-ip 0201.0000.0001 192.168.10.1, Route Distinguisher: 10.1.1.2:10
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:af:28:f4:a8:36 EvpnNdFlags:pflag
      VNI: 1010 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0001
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:af:28:f4:a8:36 EvpnNdFlags:pflag
      VNI: 1010 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0001
BGP routing table entry for mac-ip 0201.0000.0002, Route Distinguisher: 10.1.1.1:10
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010 ESI: 0000:0000:0000:0000:0002
BGP routing table entry for mac-ip 0201.0000.0002, Route Distinguisher: 10.1.1.2:10
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010 ESI: 0000:0000:0000:0000:0002
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan
      VNI: 1010 ESI: 0000:0000:0000:0000:0002
BGP routing table entry for mac-ip 0201.0000.0002 192.168.10.2, Route Distinguisher: 10.1.1.1:10
 Paths: 1 available
  Local
    - from - (0.0.0.0)
      Origin IGP, metric -, localpref -, weight 0, tag 0, valid, local, best
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnNdFlags:pflag
      VNI: 1010 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0002
BGP routing table entry for mac-ip 0201.0000.0002 192.168.10.2, Route Distinguisher: 10.1.1.2:10
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:af:28:f4:a8:36
      VNI: 1010 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0002
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1010 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:af:28:f4:a8:36
      VNI: 1010 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0002
BGP routing table entry for mac-ip 0201.0000.0003, Route Distinguisher: 10.1.1.2:20
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020 ESI: 0000:0000:0000:0000:0003
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020 ESI: 0000:0000:0000:0000:0003
BGP routing table entry for mac-ip 0201.0000.0003, Route Distinguisher: 10.1.1.3:20
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020 ESI: 0000:0000:0000:0000:0003
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020 ESI: 0000:0000:0000:0000:0003
BGP routing table entry for mac-ip 0201.0000.0003 192.168.20.3, Route Distinguisher: 10.1.1.2:20
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:af:28:f4:a8:36
      VNI: 1020 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0003
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:af:28:f4:a8:36
      VNI: 1020 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0003
BGP routing table entry for mac-ip 0201.0000.0003 192.168.20.3, Route Distinguisher: 10.1.1.3:20
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:08:f9:4a:bd:4a EvpnNdFlags:pflag
      VNI: 1020 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0003
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:08:f9:4a:bd:4a EvpnNdFlags:pflag
      VNI: 1020 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0003
BGP routing table entry for mac-ip 0201.0000.0004, Route Distinguisher: 10.1.1.2:20
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020 ESI: 0000:0000:0000:0000:0004
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020 ESI: 0000:0000:0000:0000:0004
BGP routing table entry for mac-ip 0201.0000.0004, Route Distinguisher: 10.1.1.3:20
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020 ESI: 0000:0000:0000:0000:0004
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan
      VNI: 1020 ESI: 0000:0000:0000:0000:0004
BGP routing table entry for mac-ip 0201.0000.0004 192.168.20.4, Route Distinguisher: 10.1.1.2:20
 Paths: 2 available
  65100 65002
    10.1.1.2 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:af:28:f4:a8:36
      VNI: 1020 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0004
  65100 65002
    10.1.1.2 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:af:28:f4:a8:36
      VNI: 1020 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0004
BGP routing table entry for mac-ip 0201.0000.0004 192.168.20.4, Route Distinguisher: 10.1.1.3:20
 Paths: 2 available
  65100 65003
    10.1.1.3 from fe80::5234:ceff:fe1e:87c9%Et2 (10.1.0.2)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP head, ECMP, best, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:08:f9:4a:bd:4a
      VNI: 1020 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0004
  65100 65003
    10.1.1.3 from fe80::523c:3aff:fe3f:d9d7%Et1 (10.1.0.1)
      Origin IGP, metric -, localpref 100, weight 0, tag 0, valid, external, ECMP, ECMP contributor
      Extended Community: Route-Target-AS:1:1000 Route-Target-AS:1:1020 TunnelEncap:tunnelTypeVxlan EvpnRouterMac:50:08:f9:4a:bd:4a
      VNI: 1020 L3 VNI: 1000 ESI: 0000:0000:0000:0000:0004
```

Клиенты видны в своих персональных ESI-сегментах, с чем их и поздравим.

### Остальные проверки
Проверим, как выглядит наш EVI:
```
Leaf-1# show bgp evpn instance 
EVPN instance: VLAN 10
  Route distinguisher: 0:0
  Route target import: Route-Target-AS:1:1010
  Route target export: Route-Target-AS:1:1010
  Service interface: VLAN-based
  Local VXLAN IP address: 10.1.1.1
  VXLAN: enabled
  MPLS: disabled
  Local ethernet segment:
    ESI: 0000:0000:0000:0000:0002
      Interface: Port-Channel2
      Mode: all-active
      State: up
      ES-Import RT: 00:00:00:00:00:02
      DF election algorithm: modulus
      Designated forwarder: 10.1.1.1
      Non-Designated forwarder: 10.1.1.2
    ESI: 0000:0000:0000:0000:0001
      Interface: Port-Channel1
      Mode: all-active
      State: up
      ES-Import RT: 00:00:00:00:00:01
      DF election algorithm: modulus
      Designated forwarder: 10.1.1.1
      Non-Designated forwarder: 10.1.1.2
```
Здесь появились некоторые новые сущности - а именно, мы видим ES-Import RT, заданный для сегмента, режим Multihoming'а - All-Active (режим по умолчанию), также из интересного мы здесь видим, какой из VTEP'ов является Designated Forwarder'ом для конкретного сегмента, а который им не является.

```
Leaf-1# show vxlan vni
VNI to VLAN Mapping for Vxlan1
VNI        VLAN       Source       Interface           802.1Q Tag
---------- ---------- ------------ ------------------- ----------
1010       10         static       Port-Channel1       untagged  
                                   Port-Channel2       untagged  
                                   Vxlan1              10        

VNI to dynamic VLAN Mapping for Vxlan1
VNI        VLAN       VRF        Source       
---------- ---------- ---------- ------------ 
1000       4094       VRF1       evpn         
```
Тут вроде бы ничего неожиданного.

```
Leaf-1# show vxlan vtep
Remote VTEPS for Vxlan1:

VTEP           Tunnel Type(s)
-------------- --------------
10.1.1.2       flood, unicast
10.1.1.3       unicast       

Total number of remote VTEPS:  2
```
Видим, что с 10.1.1.3 у нас нет общих VNI, поэтому пересылать на него BUM-трафик мы не будем (туннель flood не построен).

Посмотрим L2 RIB:
```
Leaf-1# show l2Rib input all
0201.0000.0002, VLAN 10, seq 1, pref 16, learnedDynamicMac, source: Local Dynamic
   Port-Channel2
0201.0000.0001, VLAN 10, seq 3, pref 16, learnedDynamicMac, source: Local Dynamic
   Port-Channel1
```
Видно двух наших локально подключенных клиентов. За своими Port-Channel'ами.

Проверим таблицу маршрутизации VRF1:
```
Leaf-1# show ip route vrf VRF1

VRF: VRF1
Codes: C - connected, S - static, K - kernel, 
       O - OSPF, IA - OSPF inter area, E1 - OSPF external type 1,
       E2 - OSPF external type 2, N1 - OSPF NSSA external type 1,
       N2 - OSPF NSSA external type2, B - Other BGP Routes,
       B I - iBGP, B E - eBGP, R - RIP, I L1 - IS-IS level 1,
       I L2 - IS-IS level 2, O3 - OSPFv3, A B - BGP Aggregate,
       A O - OSPF Summary, NG - Nexthop Group Static Route,
       V - VXLAN Control Service, M - Martian,
       DH - DHCP client installed default route,
       DP - Dynamic Policy Route, L - VRF Leaked,
       G  - gRIBI, RC - Route Cache Route

Gateway of last resort is not set

 C        192.168.10.0/24 is directly connected, Vlan10
 B E      192.168.20.3/32 [200/0] via VTEP 10.1.1.2 VNI 1000 router-mac 50:af:28:f4:a8:36 local-interface Vxlan1
                                  via VTEP 10.1.1.3 VNI 1000 router-mac 50:08:f9:4a:bd:4a local-interface Vxlan1
 B E      192.168.20.4/32 [200/0] via VTEP 10.1.1.2 VNI 1000 router-mac 50:af:28:f4:a8:36 local-interface Vxlan1
                                  via VTEP 10.1.1.3 VNI 1000 router-mac 50:08:f9:4a:bd:4a local-interface Vxlan1
```
Видим, что клиенты из VNI 1020 доступны через транзитный L3VNI 1000 по нескольким путям (Leaf-2 и Leaf-3).

## Проверка Leaf-2

Проверим состояние LAG'ов для наших клиентов:
```
Leaf-2# show lacp peer 
State: A = Active, P = Passive; S=ShortTimeout, L=LongTimeout;
       G = Aggregable, I = Individual; s+=InSync, s-=OutOfSync;
       C = Collecting, X = state machine expired,
       D = Distributing, d = default neighbor state
                 |                        Partner                              
 Port    Status  | Sys-id                    Port#   State     OperKey  PortPri
------ ----------|------------------------- ------- --------- --------- -------
Port Channel Port-Channel1:                                            
 Et3     Bundled | FFFF,02-00-00-00-01-01        2   ALGs+CD    0x0009      255
Port Channel Port-Channel2:                                            
 Et4     Bundled | FFFF,02-00-00-00-02-01        2   ALGs+CD    0x0009      255
Port Channel Port-Channel3:                                            
 Et5     Bundled | FFFF,02-00-00-00-03-01        1   ALGs+CD    0x0009      255
Port Channel Port-Channel4:                                            
 Et6     Bundled | FFFF,02-00-00-00-01-01        1   ALGs+CD    0x0009      255
```
Наши LAG'и работают :)

Пройдемся по маршрутам:

### RT-3
```
Leaf-2# show bgp evpn route-type imet
BGP routing table information for VRF default
Router identifier 10.1.1.2, local AS number 65002
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 10.1.1.1:10 imet 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 imet 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:10 imet 10.1.1.2
                                 -                     -       -       0       i
 * >      RD: 10.1.1.2:20 imet 10.1.1.2
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:20 imet 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 imet 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i

```

### RT-1
```
Leaf-2# show bgp evpn route-type auto-discovery
BGP routing table information for VRF default
Router identifier 10.1.1.2, local AS number 65002
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0001
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0001
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0001
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0002
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0002
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0002
                                 -                     -       -       0       i
 * >      RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 10.1.1.3              -       100     0       65100 65003 i
 * >      RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0003
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0003
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0003
                                 10.1.1.3              -       100     0       65100 65003 i
 * >      RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 10.1.1.3              -       100     0       65100 65003 i
 * >      RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0004
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0004
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0004
                                 10.1.1.3              -       100     0       65100 65003 i
```

### RT-4
```
Leaf-2# show bgp evpn route-type ethernet-segment
BGP routing table information for VRF default
Router identifier 10.1.1.2, local AS number 65002
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.2
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.2
                                 -                     -       -       0       i
 * >      RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.2
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
 * >      RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.2
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.3
                                 10.1.1.3              -       100     0       65100 65003 i
```

### И RT-2
```
Leaf-2# show bgp evpn route-type mac-ip
BGP routing table information for VRF default
Router identifier 10.1.1.2, local AS number 65002
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0001
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0001
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:10 mac-ip 0201.0000.0001
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0001 192.168.10.1
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0001 192.168.10.1
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:10 mac-ip 0201.0000.0001 192.168.10.1
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0002
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0002
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:10 mac-ip 0201.0000.0002
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0002 192.168.10.2
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0002 192.168.10.2
                                 10.1.1.1              -       100     0       65100 65001 i
 * >      RD: 10.1.1.2:10 mac-ip 0201.0000.0002 192.168.10.2
                                 -                     -       -       0       i
 * >      RD: 10.1.1.2:20 mac-ip 0201.0000.0003
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:20 mac-ip 0201.0000.0003
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 mac-ip 0201.0000.0003
                                 10.1.1.3              -       100     0       65100 65003 i
 * >      RD: 10.1.1.2:20 mac-ip 0201.0000.0003 192.168.20.3
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:20 mac-ip 0201.0000.0003 192.168.20.3
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 mac-ip 0201.0000.0003 192.168.20.3
                                 10.1.1.3              -       100     0       65100 65003 i
 * >      RD: 10.1.1.2:20 mac-ip 0201.0000.0004
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:20 mac-ip 0201.0000.0004
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 mac-ip 0201.0000.0004
                                 10.1.1.3              -       100     0       65100 65003 i
 * >      RD: 10.1.1.2:20 mac-ip 0201.0000.0004 192.168.20.4
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.3:20 mac-ip 0201.0000.0004 192.168.20.4
                                 10.1.1.3              -       100     0       65100 65003 i
 *  ec    RD: 10.1.1.3:20 mac-ip 0201.0000.0004 192.168.20.4
                                 10.1.1.3              -       100     0       65100 65003 i
```

### Остальное
EVI:
```
Leaf-2# show bgp evpn instance 
EVPN instance: VLAN 10
  Route distinguisher: 0:0
  Route target import: Route-Target-AS:1:1010
  Route target export: Route-Target-AS:1:1010
  Service interface: VLAN-based
  Local VXLAN IP address: 10.1.1.2
  VXLAN: enabled
  MPLS: disabled
  Local ethernet segment:
    ESI: 0000:0000:0000:0000:0001
      Interface: Port-Channel1
      Mode: all-active
      State: up
      ES-Import RT: 00:00:00:00:00:01
      DF election algorithm: modulus
      Designated forwarder: 10.1.1.1
      Non-Designated forwarder: 10.1.1.2
    ESI: 0000:0000:0000:0000:0002
      Interface: Port-Channel2
      Mode: all-active
      State: up
      ES-Import RT: 00:00:00:00:00:02
      DF election algorithm: modulus
      Designated forwarder: 10.1.1.1
      Non-Designated forwarder: 10.1.1.2
EVPN instance: VLAN 20
  Route distinguisher: 0:0
  Route target import: Route-Target-AS:1:1020
  Route target export: Route-Target-AS:1:1020
  Service interface: VLAN-based
  Local VXLAN IP address: 10.1.1.2
  VXLAN: enabled
  MPLS: disabled
  Local ethernet segment:
    ESI: 0000:0000:0000:0000:0003
      Interface: Port-Channel3
      Mode: all-active
      State: up
      ES-Import RT: 00:00:00:00:00:03
      DF election algorithm: modulus
      Designated forwarder: 10.1.1.2
      Non-Designated forwarder: 10.1.1.3
    ESI: 0000:0000:0000:0000:0004
      Interface: Port-Channel4
      Mode: all-active
      State: up
      ES-Import RT: 00:00:00:00:00:04
      DF election algorithm: modulus
      Designated forwarder: 10.1.1.2
      Non-Designated forwarder: 10.1.1.3
```
Все выглядит в порядке.

```
Leaf-2# show vxlan vni
VNI to VLAN Mapping for Vxlan1
VNI        VLAN       Source       Interface           802.1Q Tag
---------- ---------- ------------ ------------------- ----------
1010       10         static       Port-Channel1       untagged  
                                   Port-Channel2       untagged  
                                   Vxlan1              10        
1020       20         static       Port-Channel3       untagged  
                                   Port-Channel4       untagged  
                                   Vxlan1              20        

VNI to dynamic VLAN Mapping for Vxlan1
VNI        VLAN       VRF        Source       
---------- ---------- ---------- ------------ 
1000       4094       VRF1       evpn         
```

```
Leaf-2# show vxlan vtep
Remote VTEPS for Vxlan1:

VTEP           Tunnel Type(s)
-------------- --------------
10.1.1.1       unicast, flood
10.1.1.3       unicast, flood

Total number of remote VTEPS:  2
```

L2RIB:
```
Leaf-2# show l2rib input all
0201.0000.0003, VLAN 20, seq 1, pref 16, learnedDynamicMac, source: Local Dynamic
   Port-Channel3
0201.0000.0004, VLAN 20, seq 1, pref 16, learnedDynamicMac, source: Local Dynamic
   Port-Channel4
0201.0000.0002, VLAN 10, seq 1, pref 16, learnedDynamicMac, source: Local Dynamic
   Port-Channel2
0201.0000.0001, VLAN 10, seq 2, pref 16, learnedDynamicMac, source: Local Dynamic
   Port-Channel1
```
Все 4 клиента видны как локальные.

Таблица маршрутизации:
```
Leaf-2# show ip route vrf VRF1

VRF: VRF1
Codes: C - connected, S - static, K - kernel, 
       O - OSPF, IA - OSPF inter area, E1 - OSPF external type 1,
       E2 - OSPF external type 2, N1 - OSPF NSSA external type 1,
       N2 - OSPF NSSA external type2, B - Other BGP Routes,
       B I - iBGP, B E - eBGP, R - RIP, I L1 - IS-IS level 1,
       I L2 - IS-IS level 2, O3 - OSPFv3, A B - BGP Aggregate,
       A O - OSPF Summary, NG - Nexthop Group Static Route,
       V - VXLAN Control Service, M - Martian,
       DH - DHCP client installed default route,
       DP - Dynamic Policy Route, L - VRF Leaked,
       G  - gRIBI, RC - Route Cache Route

Gateway of last resort is not set

 C        192.168.10.0/24 is directly connected, Vlan10
 C        192.168.20.0/24 is directly connected, Vlan20
```
Обе сети у нас являются локально подключенными, поэтому здесь весьма пусто, никаких интересных прилетевших по BGP маршрутов нет.

## Проверка Leaf-3

Проверим состояние LAG'ов для наших клиентов:
```
Leaf-3# show lacp peer
State: A = Active, P = Passive; S=ShortTimeout, L=LongTimeout;
       G = Aggregable, I = Individual; s+=InSync, s-=OutOfSync;
       C = Collecting, X = state machine expired,
       D = Distributing, d = default neighbor state
                 |                        Partner                              
 Port    Status  | Sys-id                    Port#   State     OperKey  PortPri
------ ----------|------------------------- ------- --------- --------- -------
Port Channel Port-Channel3:                                            
 Et5     Bundled | FFFF,02-00-00-00-03-01        2   ALGs+CD    0x0009      255
Port Channel Port-Channel4:                                            
 Et6     Bundled | FFFF,02-00-00-00-04-01        2   ALGs+CD    0x0009      255
```
Наши LAG'и работают :)

Пройдемся по маршрутам:

### RT-3
```
Leaf-3# show bgp evpn route-type imet
BGP routing table information for VRF default
Router identifier 10.1.1.3, local AS number 65003
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 10.1.1.1:10 imet 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 imet 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:10 imet 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 imet 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.2:20 imet 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 imet 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:20 imet 10.1.1.3
                                 -                     -       -       0       i
```

### RT-1
```
Leaf-3# show bgp evpn route-type auto-discovery
BGP routing table information for VRF default
Router identifier 10.1.1.3, local AS number 65003
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0001
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0001
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0001
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0001
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0001
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 auto-discovery 0 0000:0000:0000:0000:0002
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0002
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:1 auto-discovery 0000:0000:0000:0000:0002
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0002
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0002
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0003
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0003
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0003
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0003
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:20 auto-discovery 0 0000:0000:0000:0000:0004
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0004
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 auto-discovery 0000:0000:0000:0000:0004
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:1 auto-discovery 0000:0000:0000:0000:0004
                                 -                     -       -       0       i
```

### RT-4
```
Leaf-3# show bgp evpn route-type ethernet-segment
BGP routing table information for VRF default
Router identifier 10.1.1.3, local AS number 65003
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0001 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.1
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0002 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0003 10.1.1.3
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:1 ethernet-segment 0000:0000:0000:0000:0004 10.1.1.3
                                 -                     -       -       0       i
```

### RT-2
```
Leaf-3# show bgp evpn route-type mac-ip
BGP routing table information for VRF default
Router identifier 10.1.1.3, local AS number 65003
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0001
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0001
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:10 mac-ip 0201.0000.0001
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 mac-ip 0201.0000.0001
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0001 192.168.10.1
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0001 192.168.10.1
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:10 mac-ip 0201.0000.0001 192.168.10.1
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 mac-ip 0201.0000.0001 192.168.10.1
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0002
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0002
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:10 mac-ip 0201.0000.0002
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 mac-ip 0201.0000.0002
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0002 192.168.10.2
                                 10.1.1.1              -       100     0       65100 65001 i
 *  ec    RD: 10.1.1.1:10 mac-ip 0201.0000.0002 192.168.10.2
                                 10.1.1.1              -       100     0       65100 65001 i
 * >Ec    RD: 10.1.1.2:10 mac-ip 0201.0000.0002 192.168.10.2
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:10 mac-ip 0201.0000.0002 192.168.10.2
                                 10.1.1.2              -       100     0       65100 65002 i
 * >Ec    RD: 10.1.1.2:20 mac-ip 0201.0000.0003
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 mac-ip 0201.0000.0003
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:20 mac-ip 0201.0000.0003
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:20 mac-ip 0201.0000.0003 192.168.20.3
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 mac-ip 0201.0000.0003 192.168.20.3
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:20 mac-ip 0201.0000.0003 192.168.20.3
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:20 mac-ip 0201.0000.0004
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 mac-ip 0201.0000.0004
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:20 mac-ip 0201.0000.0004
                                 -                     -       -       0       i
 * >Ec    RD: 10.1.1.2:20 mac-ip 0201.0000.0004 192.168.20.4
                                 10.1.1.2              -       100     0       65100 65002 i
 *  ec    RD: 10.1.1.2:20 mac-ip 0201.0000.0004 192.168.20.4
                                 10.1.1.2              -       100     0       65100 65002 i
 * >      RD: 10.1.1.3:20 mac-ip 0201.0000.0004 192.168.20.4
                                 -                     -       -       0       i
```

### Остальное
EVI:
```
Leaf-3# show bgp evpn instance 
EVPN instance: VLAN 20
  Route distinguisher: 0:0
  Route target import: Route-Target-AS:1:1020
  Route target export: Route-Target-AS:1:1020
  Service interface: VLAN-based
  Local VXLAN IP address: 10.1.1.3
  VXLAN: enabled
  MPLS: disabled
  Local ethernet segment:
    ESI: 0000:0000:0000:0000:0003
      Interface: Port-Channel3
      Mode: all-active
      State: up
      ES-Import RT: 00:00:00:00:00:03
      DF election algorithm: modulus
      Designated forwarder: 10.1.1.2
      Non-Designated forwarder: 10.1.1.3
    ESI: 0000:0000:0000:0000:0004
      Interface: Port-Channel4
      Mode: all-active
      State: up
      ES-Import RT: 00:00:00:00:00:04
      DF election algorithm: modulus
      Designated forwarder: 10.1.1.2
      Non-Designated forwarder: 10.1.1.3
```
Все выглядит в порядке.

```
Leaf-3# show vxlan vni
VNI to VLAN Mapping for Vxlan1
VNI        VLAN       Source       Interface           802.1Q Tag
---------- ---------- ------------ ------------------- ----------
1020       20         static       Port-Channel3       untagged  
                                   Port-Channel4       untagged  
                                   Vxlan1              20        

VNI to dynamic VLAN Mapping for Vxlan1
VNI        VLAN       VRF        Source       
---------- ---------- ---------- ------------ 
1000       4094       VRF1       evpn       
```

```
Leaf-3# show vxlan vtep
Remote VTEPS for Vxlan1:

VTEP           Tunnel Type(s)
-------------- --------------
10.1.1.1       unicast       
10.1.1.2       flood, unicast

Total number of remote VTEPS:  2
```

L2RIB:
```
Leaf-3# show l2rib input all
0201.0000.0003, VLAN 20, seq 2, pref 16, learnedDynamicMac, source: Local Dynamic
   Port-Channel3
0201.0000.0004, VLAN 20, seq 1, pref 16, learnedDynamicMac, source: Local Dynamic
   Port-Channel4
```

Таблица маршрутизации:
```
Leaf-3# show ip route vrf VRF1

VRF: VRF1
Codes: C - connected, S - static, K - kernel, 
       O - OSPF, IA - OSPF inter area, E1 - OSPF external type 1,
       E2 - OSPF external type 2, N1 - OSPF NSSA external type 1,
       N2 - OSPF NSSA external type2, B - Other BGP Routes,
       B I - iBGP, B E - eBGP, R - RIP, I L1 - IS-IS level 1,
       I L2 - IS-IS level 2, O3 - OSPFv3, A B - BGP Aggregate,
       A O - OSPF Summary, NG - Nexthop Group Static Route,
       V - VXLAN Control Service, M - Martian,
       DH - DHCP client installed default route,
       DP - Dynamic Policy Route, L - VRF Leaked,
       G  - gRIBI, RC - Route Cache Route

Gateway of last resort is not set

 B E      192.168.10.1/32 [200/0] via VTEP 10.1.1.2 VNI 1000 router-mac 50:af:28:f4:a8:36 local-interface Vxlan1
                                  via VTEP 10.1.1.1 VNI 1000 router-mac 50:cb:f9:a2:93:cf local-interface Vxlan1
 B E      192.168.10.2/32 [200/0] via VTEP 10.1.1.2 VNI 1000 router-mac 50:af:28:f4:a8:36 local-interface Vxlan1
                                  via VTEP 10.1.1.1 VNI 1000 router-mac 50:cb:f9:a2:93:cf local-interface Vxlan1
 C        192.168.20.0/24 is directly connected, Vlan20
```
Client-1 и Client-2 видны за Leaf-1 и Leaf-2.

### Проверка связности между клиентами

Проверять будем таким образом. Сначала мы на клиенте делаем пинг всех других клиентов (проверим таким образом передачу трафика intra-VNI и inter-VNI). После этого мы запустим пинг с Client-1 до Client-4, а на Client-4 попеременно будем отключать оба линка и проверять, что трафик перетекает на уцелевший линк.

#### Client-1
ping Client-2 (intra-VNI)
```
Client-1:~# ping 192.168.10.2 -c 3
PING 192.168.10.2 (192.168.10.2): 56 data bytes
64 bytes from 192.168.10.2: seq=0 ttl=64 time=8.603 ms
64 bytes from 192.168.10.2: seq=1 ttl=64 time=3.372 ms
64 bytes from 192.168.10.2: seq=2 ttl=64 time=4.018 ms

--- 192.168.10.2 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 3.372/5.331/8.603 ms
```

ping Client-3 (inter-VNI)
```
Client-1:~# ping 192.168.20.3 -c 3
PING 192.168.20.3 (192.168.20.3): 56 data bytes
64 bytes from 192.168.20.3: seq=0 ttl=62 time=12.295 ms
64 bytes from 192.168.20.3: seq=1 ttl=62 time=11.075 ms
64 bytes from 192.168.20.3: seq=2 ttl=62 time=11.184 ms

--- 192.168.20.3 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 11.075/11.518/12.295 ms
```

ping Client-4 (inter-VNI)
```
Client-1:~#  ping 192.168.20.4 -c 3
PING 192.168.20.4 (192.168.20.4): 56 data bytes
64 bytes from 192.168.20.4: seq=0 ttl=63 time=8.562 ms
64 bytes from 192.168.20.4: seq=1 ttl=63 time=4.720 ms
64 bytes from 192.168.20.4: seq=2 ttl=63 time=6.052 ms

--- 192.168.20.4 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 4.720/6.444/8.562 ms
```

ARP-таблица Client-1:
```
Client-1:~# ip nei
192.168.10.2 dev bond0 lladdr 02:01:00:00:00:02 used 0/0/0 probes 4 STALE
192.168.10.254 dev bond0 lladdr 02:aa:aa:aa:aa:aa ref 1 used 0/0/0 probes 4 REACHABLE
```
Видим Client-2, находящегося с нами в одном сегменте, а также свой шлюз.

#### Client-2
ping Client-1 (intra-VNI)
```
Client-2:~# ping 192.168.10.1 -c 3
PING 192.168.10.1 (192.168.10.1): 56 data bytes
64 bytes from 192.168.10.1: seq=0 ttl=64 time=4.128 ms
64 bytes from 192.168.10.1: seq=1 ttl=64 time=4.187 ms
64 bytes from 192.168.10.1: seq=2 ttl=64 time=4.307 ms

--- 192.168.10.1 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 4.128/4.207/4.307 ms
```

ping Client-3 (inter-VNI)
```
Client-2:~# ping 192.168.20.3 -c 3
PING 192.168.20.3 (192.168.20.3): 56 data bytes
64 bytes from 192.168.20.3: seq=0 ttl=62 time=19.535 ms
64 bytes from 192.168.20.3: seq=1 ttl=62 time=18.696 ms
64 bytes from 192.168.20.3: seq=2 ttl=62 time=14.483 ms

--- 192.168.20.3 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 14.483/17.571/19.535 ms
```

ping Client-4 (inter-VNI)
```
Client-2:~# ping 192.168.20.4 -c 3
PING 192.168.20.4 (192.168.20.4): 56 data bytes
64 bytes from 192.168.20.4: seq=0 ttl=63 time=10.392 ms
64 bytes from 192.168.20.4: seq=1 ttl=63 time=10.753 ms
64 bytes from 192.168.20.4: seq=2 ttl=63 time=10.574 ms

--- 192.168.20.4 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 10.392/10.573/10.753 ms
```

ARP-таблица:
```
Client-2:~# ip nei
192.168.10.1 dev bond0 lladdr 02:01:00:00:00:01 used 0/0/0 probes 1 STALE
192.168.10.254 dev bond0 lladdr 02:aa:aa:aa:aa:aa ref 1 used 0/0/0 probes 4 REACHABLE
```

#### Client-3
ping Client-1 (inter-VNI)
```
Client-3:~# ping 192.168.10.1 -c 3
PING 192.168.10.1 (192.168.10.1): 56 data bytes
64 bytes from 192.168.10.1: seq=0 ttl=63 time=13.054 ms
64 bytes from 192.168.10.1: seq=1 ttl=63 time=10.944 ms
64 bytes from 192.168.10.1: seq=2 ttl=63 time=9.861 ms

--- 192.168.10.1 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 9.861/11.286/13.054 ms
```

ping Client-2 (inter-VNI)
```
Client-3:~# ping 192.168.10.2 -c 3
PING 192.168.10.2 (192.168.10.2): 56 data bytes
64 bytes from 192.168.10.2: seq=0 ttl=62 time=20.178 ms
64 bytes from 192.168.10.2: seq=1 ttl=62 time=15.954 ms
64 bytes from 192.168.10.2: seq=2 ttl=62 time=15.043 ms

--- 192.168.10.2 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 15.043/17.058/20.178 ms
```

ping Client-4 (intra-VNI)
```
Client-3:~# ping 192.168.20.4 -c 3
PING 192.168.20.4 (192.168.20.4): 56 data bytes
64 bytes from 192.168.20.4: seq=0 ttl=64 time=7.838 ms
64 bytes from 192.168.20.4: seq=1 ttl=64 time=4.361 ms
64 bytes from 192.168.20.4: seq=2 ttl=64 time=3.857 ms

--- 192.168.20.4 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 3.857/5.352/7.838 ms
```

ARP-таблица:
```
Client-3:~# ip nei
192.168.20.254 dev bond0 lladdr 02:aa:aa:aa:aa:aa ref 1 used 0/0/0 probes 4 REACHABLE
192.168.20.4 dev bond0 lladdr 02:01:00:00:00:04 ref 1 used 0/0/0 probes 4 REACHABLE
```

#### Client-4
ping Client-1 (inter-VNI)
```
Client-4:~# ping 192.168.10.1 -c 3
PING 192.168.10.1 (192.168.10.1): 56 data bytes
64 bytes from 192.168.10.1: seq=0 ttl=63 time=5.339 ms
64 bytes from 192.168.10.1: seq=1 ttl=63 time=5.535 ms
64 bytes from 192.168.10.1: seq=2 ttl=63 time=5.292 ms

--- 192.168.10.1 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 5.292/5.388/5.535 ms
```

ping Client-2 (inter-VNI)
```
Client-4:~# ping 192.168.10.2 -c 3
PING 192.168.10.2 (192.168.10.2): 56 data bytes
64 bytes from 192.168.10.2: seq=0 ttl=62 time=16.560 ms
64 bytes from 192.168.10.2: seq=1 ttl=62 time=15.729 ms
64 bytes from 192.168.10.2: seq=2 ttl=62 time=10.968 ms

--- 192.168.10.2 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 10.968/14.419/16.560 ms
```

ping Client-3 (intra-VNI)
```
Client-4:~# ping 192.168.20.3 -c 3
PING 192.168.20.3 (192.168.20.3): 56 data bytes
64 bytes from 192.168.20.3: seq=0 ttl=64 time=4.463 ms
64 bytes from 192.168.20.3: seq=1 ttl=64 time=4.039 ms
64 bytes from 192.168.20.3: seq=2 ttl=64 time=4.358 ms

--- 192.168.20.3 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 4.039/4.286/4.463 ms
```

ARP-таблица:
```
Client-4:~# ip nei
192.168.20.3 dev bond0 lladdr 02:01:00:00:00:03 ref 1 used 0/0/0 probes 1 REACHABLE
192.168.20.254 dev bond0 lladdr 02:aa:aa:aa:aa:aa used 0/0/0 probes 4 STALE
```

### Проверка резервируемости

Давайте запустим на Client-1 пинг Client-4, а затем на Client-4 сначала отключим одну ногу, затем включим ее обратно и отключим вторую. Пинги должны восстановиться после некоторого периода.

Сначала проверим, через какую ногу идет пинг:
```
root@pnetlab:~# tcpdump -n -e -i vunl8_0 icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on vunl8_0, link-type EN10MB (Ethernet), capture size 262144 bytes
18:46:50.246390 50:af:28:f4:a8:36 > 02:01:00:00:00:04, ethertype IPv4 (0x0800), length 98: 192.168.10.1 > 192.168.20.4: ICMP echo request, id 2408, seq 31, length 64
18:46:50.246635 02:01:00:00:00:04 > 02:aa:aa:aa:aa:aa, ethertype IPv4 (0x0800), length 98: 192.168.20.4 > 192.168.10.1: ICMP echo reply, id 2408, seq 31, length 64
18:46:51.246248 50:af:28:f4:a8:36 > 02:01:00:00:00:04, ethertype IPv4 (0x0800), length 98: 192.168.10.1 > 192.168.20.4: ICMP echo request, id 2408, seq 32, length 64
18:46:51.246633 02:01:00:00:00:04 > 02:aa:aa:aa:aa:aa, ethertype IPv4 (0x0800), length 98: 192.168.20.4 > 192.168.10.1: ICMP echo reply, id 2408, seq 32, length 64
18:46:52.246585 50:af:28:f4:a8:36 > 02:01:00:00:00:04, ethertype IPv4 (0x0800), length 98: 192.168.10.1 > 192.168.20.4: ICMP echo request, id 2408, seq 33, length 64
18:46:52.246781 02:01:00:00:00:04 > 02:aa:aa:aa:aa:aa, ethertype IPv4 (0x0800), length 98: 192.168.20.4 > 192.168.10.1: ICMP echo reply, id 2408, seq 33, length 64
18:46:53.247212 50:af:28:f4:a8:36 > 02:01:00:00:00:04, ethertype IPv4 (0x0800), length 98: 192.168.10.1 > 192.168.20.4: ICMP echo request, id 2408, seq 34, length 64
18:46:53.247447 02:01:00:00:00:04 > 02:aa:aa:aa:aa:aa, ethertype IPv4 (0x0800), length 98: 192.168.20.4 > 192.168.10.1: ICMP echo reply, id 2408, seq 34, length 64
^C
8 packets captured
8 packets received by filter
0 packets dropped by kernel
```
Это интерфейс "eth0" на Client-4.
```
root@pnetlab:~# tcpdump -n -e -i vunl8_1 icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on vunl8_1, link-type EN10MB (Ethernet), capture size 262144 bytes
^C
0 packets captured
0 packets received by filter
0 packets dropped by kernel
```
На "eth1" трафика нет.

Отключим eth0:
![[mh_eth0_down.png]]

Пинг прервался, но после некоторого (длительного) перерыва - восстановился. Что ж поделаешь, виртуалки...
```
Client-1:~# ping 192.168.20.4
PING 192.168.20.4 (192.168.20.4): 56 data bytes
64 bytes from 192.168.20.4: seq=0 ttl=63 time=5.028 ms
64 bytes from 192.168.20.4: seq=1 ttl=63 time=5.236 ms
...
64 bytes from 192.168.20.4: seq=82 ttl=63 time=5.096 ms
64 bytes from 192.168.20.4: seq=83 ttl=63 time=5.361 ms
64 bytes from 192.168.20.4: seq=84 ttl=63 time=5.308 ms
64 bytes from 192.168.20.4: seq=85 ttl=63 time=5.450 ms
64 bytes from 192.168.20.4: seq=86 ttl=63 time=5.198 ms
64 bytes from 192.168.20.4: seq=87 ttl=63 time=5.541 ms
...
<no ping>
...
64 bytes from 192.168.20.4: seq=154 ttl=62 time=19.046 ms
64 bytes from 192.168.20.4: seq=155 ttl=62 time=15.463 ms
64 bytes from 192.168.20.4: seq=156 ttl=62 time=15.358 ms
64 bytes from 192.168.20.4: seq=157 ttl=62 time=14.778 ms
64 bytes from 192.168.20.4: seq=158 ttl=62 time=14.146 ms
64 bytes from 192.168.20.4: seq=159 ttl=62 time=14.036 ms
```

Посмотрим, идет ли трафик теперь по eth1:
```
root@pnetlab:~# tcpdump -n -e -i vunl8_1 icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on vunl8_1, link-type EN10MB (Ethernet), capture size 262144 bytes
18:50:04.222636 50:af:28:f4:a8:36 > 02:01:00:00:00:04, ethertype IPv4 (0x0800), length 98: 192.168.10.1 > 192.168.20.4: ICMP echo request, id 2409, seq 0, length 64
18:50:04.226490 02:01:00:00:00:04 > 02:aa:aa:aa:aa:aa, ethertype IPv4 (0x0800), length 98: 192.168.20.4 > 192.168.10.1: ICMP echo reply, id 2409, seq 0, length 64
18:50:05.218115 50:af:28:f4:a8:36 > 02:01:00:00:00:04, ethertype IPv4 (0x0800), length 98: 192.168.10.1 > 192.168.20.4: ICMP echo request, id 2409, seq 1, length 64
18:50:05.218395 02:01:00:00:00:04 > 02:aa:aa:aa:aa:aa, ethertype IPv4 (0x0800), length 98: 192.168.20.4 > 192.168.10.1: ICMP echo reply, id 2409, seq 1, length 64
18:50:06.219176 50:af:28:f4:a8:36 > 02:01:00:00:00:04, ethertype IPv4 (0x0800), length 98: 192.168.10.1 > 192.168.20.4: ICMP echo request, id 2409, seq 2, length 64
18:50:06.219380 02:01:00:00:00:04 > 02:aa:aa:aa:aa:aa, ethertype IPv4 (0x0800), length 98: 192.168.20.4 > 192.168.10.1: ICMP echo reply, id 2409, seq 2, length 64
18:50:07.219057 50:af:28:f4:a8:36 > 02:01:00:00:00:04, ethertype IPv4 (0x0800), length 98: 192.168.10.1 > 192.168.20.4: ICMP echo request, id 2409, seq 3, length 64
18:50:07.219322 02:01:00:00:00:04 > 02:aa:aa:aa:aa:aa, ethertype IPv4 (0x0800), length 98: 192.168.20.4 > 192.168.10.1: ICMP echo reply, id 2409, seq 3, length 64
^C
8 packets captured
8 packets received by filter
0 packets dropped by kernel
```
Идет!
Резервируемость у нас работает.

С чистой совестью переходим к последней части нашей настройки - инжектированию внешних маршрутов в overlay-сеть.